<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ultima Chat</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --primary: #6366f1; --text: #f8fafc; --gray: #94a3b8; }
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; display: flex; justify-content: center; }
        
        #app { width: 100%; max-width: 480px; height: 100%; position: relative; background: var(--bg); display: flex; flex-direction: column; }
        .screen { position: absolute; inset: 0; background: var(--bg); display: flex; flex-direction: column; transform: translateX(100%); transition: 0.3s; z-index: 10; }
        .screen.active { transform: translateX(0); z-index: 20; }
        .hidden { display: none !important; }

        /* Login */
        .auth-box { padding: 40px; text-align: center; height: 100%; display: flex; flex-direction: column; justify-content: center; }
        .dp-upload { width: 100px; height: 100px; border-radius: 50%; border: 3px solid var(--primary); margin: 0 auto 20px; object-fit: cover; }
        input { width: 100%; padding: 15px; background: var(--card); border: 1px solid #334155; border-radius: 12px; color: white; margin-bottom: 10px; }
        .btn { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: bold; font-size: 16px; margin-top: 10px; cursor: pointer;}
        
        /* Dashboard */
        .nav-header { padding: 15px; background: rgba(30,41,59,0.9); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #334155; }
        .nav-tabs { display: flex; justify-content: space-around; padding: 10px; background: var(--card); }
        .tab { color: var(--gray); font-weight: 600; padding: 5px 10px; cursor: pointer; }
        .tab.active { color: var(--primary); border-bottom: 2px solid var(--primary); }

        .content-area { flex: 1; overflow-y: auto; padding: 10px; }
        
        /* Search Result Item */
        .user-card { display: flex; align-items: center; background: var(--card); padding: 12px; border-radius: 12px; margin-bottom: 10px; }
        .avatar { width: 50px; height: 50px; border-radius: 50%; margin-right: 15px; object-fit: cover; }
        .info { flex: 1; }
        .name { font-weight: 600; font-size: 16px; }
        .action-btn { background: var(--primary); color: white; padding: 8px 16px; border-radius: 8px; border: none; font-size: 12px; }

        /* Chat Screen */
        .chat-head { padding: 15px; background: var(--card); display: flex; align-items: center; border-bottom: 1px solid #334155; }
        .messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .msg { max-width: 75%; padding: 10px 14px; border-radius: 18px; font-size: 14px; word-wrap: break-word; }
        .my-msg { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 4px; }
        .other-msg { align-self: flex-start; background: var(--card); border-bottom-left-radius: 4px; }
        .media-msg { max-width: 100%; border-radius: 10px; margin-top: 5px; }
        
        .chat-input { padding: 10px; background: var(--card); display: flex; align-items: center; gap: 10px; border-top: 1px solid #334155; }
        .icon-btn { color: var(--gray); font-size: 20px; background: none; border: none; cursor: pointer; }
    </style>
</head>
<body>

<div id="app">
    <div id="login-screen" class="screen active">
        <div class="auth-box">
            <h1>Welcome</h1>
            <img id="preview-dp" src="https://cdn-icons-png.flaticon.com/512/149/149071.png" class="dp-upload" onclick="document.getElementById('dp-input').click()">
            <input type="file" id="dp-input" hidden accept="image/*">
            <p style="color:var(--gray); margin-bottom:20px; font-size:12px;">Tap image to upload DP</p>
            
            <input id="username" placeholder="Username">
            <input id="password" type="password" placeholder="Password">
            <button class="btn" onclick="auth('login')">Login</button>
            <button class="btn" onclick="auth('register')" style="background:var(--card); margin-top:10px;">Create Account</button>
        </div>
    </div>

    <div id="dashboard-screen" class="screen">
        <div class="nav-header">
            <h3>Chats</h3>
            <img id="my-nav-dp" src="" class="avatar" style="width:35px; height:35px; border:2px solid var(--primary);">
        </div>
        
        <div class="nav-tabs">
            <div class="tab active" onclick="switchTab('chats')">Chats</div>
            <div class="tab" onclick="switchTab('status')">Status</div>
            <div class="tab" onclick="switchTab('search')">Search</div>
        </div>

        <div id="tab-chats" class="content-area">
            <div id="request-box" class="hidden" style="margin-bottom:15px;">
                <p style="font-size:12px; color:var(--gray); text-transform:uppercase;">Requests</p>
                <div id="request-list"></div>
            </div>
            <div id="friend-list"></div>
        </div>

        <div id="tab-status" class="content-area hidden">
            <div class="user-card">
                <div class="info">
                    <div class="name">My Status</div>
                    <p style="font-size:12px; color:var(--gray);">Tap to add status update</p>
                </div>
                <button class="action-btn">+</button>
            </div>
            <p style="text-align:center; color:var(--gray); margin-top:20px;">No recent updates</p>
        </div>

        <div id="tab-search" class="content-area hidden">
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <input id="search-box" placeholder="Search username..." style="margin:0;">
                <button class="action-btn" onclick="searchUser()">Search</button>
            </div>
            <div id="search-results"></div>
        </div>
    </div>

    <div id="chat-screen" class="screen">
        <div class="chat-head">
            <button class="icon-btn" onclick="document.getElementById('dashboard-screen').classList.add('active')" style="margin-right:10px;"><i class="fa-solid fa-arrow-left"></i></button>
            <img id="chat-partner-dp" src="" class="avatar" style="width:35px; height:35px;">
            <div class="name" id="chat-partner-name">User</div>
        </div>
        
        <div id="messages" class="messages"></div>

        <div class="chat-input">
            <button class="icon-btn" onclick="document.getElementById('media-input').click()"><i class="fa-solid fa-paperclip"></i></button>
            <input type="file" id="media-input" hidden accept="image/*,video/*">
            <input id="msg-input" placeholder="Message..." style="margin:0; flex:1;">
            <button class="icon-btn" onclick="sendMessage()" style="color:var(--primary);"><i class="fa-solid fa-paper-plane"></i></button>
        </div>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    let myUser = null;
    let currentFriend = null;
    let uploadedDp = "https://cdn-icons-png.flaticon.com/512/149/149071.png";

    // DP Preview
    document.getElementById('dp-input').addEventListener('change', function() {
        const reader = new FileReader();
        reader.onload = e => {
            uploadedDp = e.target.result;
            document.getElementById('preview-dp').src = uploadedDp;
        }
        reader.readAsDataURL(this.files[0]);
    });

    // Auth
    function auth(type) {
        const u = document.getElementById('username').value;
        const p = document.getElementById('password').value;
        const btn = document.querySelector('.btn');
        btn.innerText = "Processing...";
        
        if(type === 'register') socket.emit('register', { username: u, password: p, avatar: uploadedDp });
        else socket.emit('login', { username: u, password: p });
    }

    socket.on('auth-success', (data) => {
        myUser = data;
        document.getElementById('my-nav-dp').src = data.avatar || uploadedDp;
        document.getElementById('login-screen').classList.remove('active');
        
        // Load Friends
        const list = document.getElementById('friend-list');
        list.innerHTML = '';
        // Note: For full app we need to fetch friend details (DP) from server. 
        // For now using placeholder or stored data if available
        data.friends.forEach(f => addFriendToList(f, 'https://cdn-icons-png.flaticon.com/512/149/149071.png')); 
        
        // Load Requests
        if(data.requests.length) {
            document.getElementById('request-box').classList.remove('hidden');
            data.requests.forEach(r => addRequestToList(r));
        }
    });

    socket.on('auth-error', msg => { alert(msg); document.querySelector('.btn').innerText = "Login"; });

    // Tabs
    function switchTab(tabName) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.content-area').forEach(c => c.classList.add('hidden'));
        
        event.target.classList.add('active');
        document.getElementById('tab-'+tabName).classList.remove('hidden');
    }

    // Search Logic (Fixed)
    function searchUser() {
        const query = document.getElementById('search-box').value;
        socket.emit('search-user', query);
    }

    socket.on('search-result', (data) => {
        const div = document.getElementById('search-results');
        div.innerHTML = '';
        
        if(data.found) {
            div.innerHTML = `
                <div class="user-card">
                    <img src="${data.avatar}" class="avatar">
                    <div class="info"><div class="name">${data.username}</div></div>
                    <button class="action-btn" onclick="sendReq('${data.username}')">Add</button>
                </div>`;
        } else {
            div.innerHTML = '<p style="text-align:center; color:var(--gray)">User not found</p>';
        }
    });

    function sendReq(target) { socket.emit('send-request', { sender: myUser.username, target }); }
    socket.on('request-sent', () => alert("Request Sent!"));
    socket.on('request-error', msg => alert(msg));

    // Request Handling
    socket.on('new-request', (data) => {
        document.getElementById('request-box').classList.remove('hidden');
        addRequestToList(data.sender); // In real app, use data.avatar
    });

    function addRequestToList(name) {
        const div = document.getElementById('request-list');
        div.innerHTML += `
            <div class="user-card">
                <div class="info"><div class="name">${name}</div></div>
                <button class="action-btn" onclick="acceptReq('${name}')">Accept</button>
            </div>`;
    }

    function acceptReq(name) {
        socket.emit('accept-request', { myName: myUser.username, friendName: name });
        document.getElementById('request-box').classList.add('hidden'); // Simplified
    }

    socket.on('friend-added', (data) => {
        addFriendToList(data.username, data.avatar);
    });

    function addFriendToList(name, avatar) {
        const list = document.getElementById('friend-list');
        const item = document.createElement('div');
        item.className = 'user-card';
        item.onclick = () => openChat(name, avatar);
        item.innerHTML = `
            <img src="${avatar || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'}" class="avatar">
            <div class="info">
                <div class="name">${name}</div>
                <div style="font-size:12px; color:var(--primary);">Tap to chat</div>
            </div>`;
        list.appendChild(item);
    }

    // Chat & Media Logic
    function openChat(name, avatar) {
        currentFriend = name;
        document.getElementById('chat-partner-name').innerText = name;
        document.getElementById('chat-partner-dp').src = avatar;
        document.getElementById('messages').innerHTML = '';
        socket.emit('join-chat', { user1: myUser.username, user2: name });
        document.getElementById('chat-screen').classList.add('active');
    }

    // File Handling
    document.getElementById('media-input').addEventListener('change', function() {
        const file = this.files[0];
        if(!file) return;

        // Check size (100MB = 100 * 1024 * 1024)
        if(file.size > 100 * 1024 * 1024) return alert("File too large! Max 100MB");

        const reader = new FileReader();
        reader.onload = function(e) {
            const type = file.type.startsWith('image') ? 'image' : 'video';
            const data = e.target.result;
            
            // Send to server
            socket.emit('private-message', { 
                sender: myUser.username, 
                friendName: currentFriend, 
                text: '', 
                file: data, 
                fileType: type 
            });
        }
        reader.readAsDataURL(file);
    });

    function sendMessage() {
        const txt = document.getElementById('msg-input').value;
        if(txt) {
            socket.emit('private-message', { sender: myUser.username, friendName: currentFriend, text: txt });
            document.getElementById('msg-input').value = '';
        }
    }

    socket.on('receive-message', (data) => {
        if(currentFriend && (data.sender === currentFriend || data.sender === myUser.username)) {
            const div = document.createElement('div');
            const isMe = data.sender === myUser.username;
            div.className = `msg ${isMe ? 'my-msg' : 'other-msg'}`;
            
            let content = data.text ? `<div>${data.text}</div>` : '';
            
            if(data.file) {
                if(data.fileType === 'image') {
                    content += `<img src="${data.file}" class="media-msg">`;
                } else if (data.fileType === 'video') {
                    content += `<video src="${data.file}" controls class="media-msg"></video>`;
                }
            }
            
            div.innerHTML = content;
            document.getElementById('messages').appendChild(div);
            document.getElementById('messages').scrollTop = 99999;
        }
    });

    socket.on('load-messages', msgs => {
        msgs.forEach(m => {
            // Re-use logic above (simplified for brevity)
             const div = document.createElement('div');
            const isMe = m.sender === myUser.username;
            div.className = `msg ${isMe ? 'my-msg' : 'other-msg'}`;
            let content = m.text ? `<div>${m.text}</div>` : '';
            if(m.file) {
                if(m.fileType === 'image') content += `<img src="${m.file}" class="media-msg">`;
                else content += `<video src="${m.file}" controls class="media-msg"></video>`;
            }
            div.innerHTML = content;
            document.getElementById('messages').appendChild(div);
        });
    });

</script>
</body>
</html>
