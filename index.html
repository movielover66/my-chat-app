<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ultima Chat - By Pritam</title>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --primary: #7c3aed; --bg: #0f172a; --card: #1e293b; --text: #f1f5f9; --input: #334155; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        /* Utility */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .center { align-items: center; justify-content: center; }
        
        /* Auth Screen */
        #auth-view { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: radial-gradient(circle at center, #1e1b4b, #0f172a); padding: 20px; }
        .auth-card { background: rgba(30, 41, 59, 0.8); backdrop-filter: blur(10px); padding: 30px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); width: 100%; max-width: 350px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        .logo { font-size: 2.5rem; font-weight: 800; background: linear-gradient(to right, #a78bfa, #2dd4bf); -webkit-background-clip: text; color: transparent; margin-bottom: 10px; }
        input { width: 100%; padding: 14px; background: var(--input); border: none; border-radius: 10px; color: white; margin-bottom: 15px; outline: none; font-size: 1rem; }
        .btn-primary { width: 100%; padding: 14px; background: linear-gradient(135deg, #7c3aed, #4f46e5); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 1rem; transition: 0.2s; }
        .btn-primary:active { transform: scale(0.98); }
        
        /* Main Layout */
        #main-view { display: none; width: 100%; height: 100%; position: relative; }
        .sidebar { width: 100%; height: 100%; background: var(--bg); display: flex; flex-direction: column; }
        
        /* Header */
        .header { padding: 15px; background: var(--card); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #334155; }
        .my-profile { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .avatar-sm { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary); }
        
        /* Status Bar */
        .status-bar { padding: 10px; overflow-x: auto; white-space: nowrap; border-bottom: 1px solid #334155; display: flex; gap: 10px; scrollbar-width: none; }
        .status-item { display: inline-flex; flex-direction: column; align-items: center; gap: 5px; width: 60px; position: relative; }
        .status-ring { width: 50px; height: 50px; border-radius: 50%; border: 2px solid #2dd4bf; padding: 2px; }
        .status-ring img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
        .add-status { border-color: #64748b; border-style: dashed; display: flex; align-items: center; justify-content: center; font-size: 20px; color: #64748b; cursor: pointer; }

        /* Search & Lists */
        .search-area { padding: 10px; position: relative; }
        .search-results { position: absolute; top: 60px; left: 10px; right: 10px; background: #1e293b; border-radius: 10px; box-shadow: 0 10px 20px rgba(0,0,0,0.5); z-index: 50; display: none; }
        .result-item { padding: 12px; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #334155; cursor: pointer; }
        
        /* Chat View */
        #chat-view { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0f172a; display: none; flex-direction: column; z-index: 100; }
        .chat-header { padding: 10px 15px; background: var(--card); display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #334155; }
        .chat-body { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; background-image: url('https://www.transparenttextures.com/patterns/cubes.png'); opacity: 0.9; }
        
        /* Messages */
        .msg { max-width: 75%; padding: 10px 14px; border-radius: 18px; font-size: 15px; line-height: 1.4; word-wrap: break-word; position: relative; }
        .msg-me { align-self: flex-end; background: linear-gradient(135deg, #7c3aed, #6d28d9); border-bottom-right-radius: 4px; }
        .msg-friend { align-self: flex-start; background: var(--card); border-bottom-left-radius: 4px; }
        .msg img { max-width: 100%; border-radius: 10px; margin-top: 5px; }
        
        /* Typing & Input */
        .typing-indicator { font-size: 12px; color: #2dd4bf; margin-left: 10px; height: 15px; visibility: hidden; }
        .chat-input-area { padding: 10px; background: var(--card); display: flex; align-items: center; gap: 10px; }
        .icon-btn { font-size: 1.5rem; color: #94a3b8; cursor: pointer; }
        
        /* Modals */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 200; }
        .modal-content { background: var(--card); padding: 25px; border-radius: 15px; width: 90%; max-width: 350px; text-align: center; }

        .footer-credit { position: fixed; bottom: 10px; width: 100%; text-align: center; color: #475569; font-size: 12px; font-weight: bold; pointer-events: none; }
        
        /* Desktop fix */
        @media(min-width: 768px) {
            body { max-width: 450px; margin: 0 auto; border: 1px solid #334155; }
            .sidebar { display: flex; }
        }
    </style>
</head>
<body>
    <audio id="notif-sound" src="https://assets.mixkit.co/active_storage/sfx/2346/2346-preview.m4a"></audio>
    <div id="auth-view">
        <div class="auth-card">
            <h1 class="logo">⚡ Ultima</h1>
            <p style="color: #94a3b8; margin-bottom: 20px;">Secure. Fast. Rocket Speed.</p>
            <input type="text" id="username" placeholder="Username (Unique)">
            <input type="password" id="password" placeholder="Password">
            <button class="btn-primary" onclick="handleAuth()">Login / Register</button>
            <p id="auth-err" style="color: #ef4444; margin-top: 10px; font-size: 14px;"></p>
        </div>
        <div class="footer-credit">Developed by PRITAM</div>
    </div>

    <div id="main-view">
        <div class="sidebar">
            <div class="header">
                <div class="my-profile" onclick="openProfileModal()">
                    <img id="my-dp" src="" class="avatar-sm">
                    <div>
                        <h3 id="my-name" style="font-size: 16px;">Loading...</h3>
                        <span style="font-size: 11px; color: #2dd4bf;">● Online</span>
                    </div>
                </div>
                <button onclick="logout()" style="background:transparent; border:none; color:#ef4444; font-size:20px;"><i class="fas fa-power-off"></i></button>
            </div>

            <div class="status-bar">
                <div class="status-item" onclick="alert('Status feature coming in update!')">
                    <div class="status-ring add-status">+</div>
                    <span style="font-size:10px;">My Status</span>
                </div>
                </div>

            <div class="search-area">
                <input type="text" id="search-input" placeholder="Search user..." oninput="searchUser(this.value)">
                <div class="search-results" id="search-results"></div>
            </div>

            <div style="padding: 10px; color: #94a3b8; font-size: 12px; font-weight: bold;">MESSAGES</div>
            <div id="friends-list" style="flex:1; overflow-y:auto;">
                </div>
            <div class="footer-credit">Developed by PRITAM</div>
        </div>
    </div>

    <div id="chat-view">
        <div class="chat-header">
            <i class="fas fa-arrow-left icon-btn" onclick="closeChat()"></i>
            <img id="chat-dp" src="" class="avatar-sm">
            <div style="flex:1;">
                <h3 id="chat-name" style="font-size: 16px;">User</h3>
                <span id="chat-status" style="font-size: 11px; color: #94a3b8;">Tap for info</span>
            </div>
        </div>
        
        <div class="chat-body" id="chat-box">
            </div>
        <div class="typing-indicator" id="typing-ind">Typing...</div>

        <div class="chat-input-area">
            <label for="file-up" class="icon-btn"><i class="fas fa-image"></i></label>
            <input type="file" id="file-up" hidden accept="image/*" onchange="uploadPhoto(this)">
            <input type="text" id="msg-input" placeholder="Type message..." oninput="handleTyping()">
            <button class="btn-primary" style="width: 50px; border-radius: 50%;" onclick="sendMsg()"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>
    
 <div id="profile-modal" class="modal">
        <div class="modal-content">
            <h3>Edit Profile</h3>
            
            <img id="edit-preview" src="" style="width:100px; height:100px; border-radius:50%; object-fit:cover; margin:15px auto; display:block; border: 3px solid #7c3aed;">
            
            <label for="avatar-upload" class="btn-primary" style="display:block; width:100%; margin-bottom:10px; cursor:pointer;">
                <i class="fas fa-camera"></i> Change Photo
            </label>
            <input type="file" id="avatar-upload" hidden accept="image/*" onchange="previewMyDP(this)">
            
            <input type="text" id="edit-bio" placeholder="Update your bio...">
            
            <button class="btn-primary" onclick="saveProfile()">Save Changes</button>
            <button onclick="document.getElementById('profile-modal').style.display='none'" style="margin-top:10px; background:transparent; border:none; color: #94a3b8;">Cancel</button>
        </div>
        </div>
    <script>
    const socket = io();
    let me = JSON.parse(localStorage.getItem('ultima_user')) || null;
    let currentRoom = null;
    let typingTimer;

    // --- 1. Session Check (Refresh fix) ---
    window.onload = () => {
        if(me) {
            initApp(me);
            socket.emit('login', { username: me.username, password: me.password });
        }
    };

    function handleAuth() {
        const u = document.getElementById('username').value.trim();
        const p = document.getElementById('password').value.trim();
        if(!u || !p) return;
        socket.emit('register', { username: u, password: p }); // Try Register first
        
        // Listen for error, if username taken -> try login
        socket.once('auth-error', (err) => {
            if(err === 'Username taken!') socket.emit('login', { username: u, password: p });
            else document.getElementById('auth-err').innerText = err;
        });
    }

    socket.on('auth-success', (user) => {
        localStorage.setItem('ultima_user', JSON.stringify(user));
        me = user;
        initApp(user);
    });

    function initApp(user) {
        document.getElementById('auth-view').classList.add('hidden');
        document.getElementById('main-view').style.display = 'block';
        updateMyUI(user);
        socket.emit('join-user', user.username);
        loadFriendsList(user.friends, user.requests);
    }

    function updateMyUI(user) {
        document.getElementById('my-name').innerText = user.username;
        document.getElementById('my-dp').src = user.avatar;
        document.getElementById('edit-bio').value = user.bio;
        document.getElementById('edit-avatar').value = user.avatar;
        document.getElementById('edit-preview').src = user.avatar;
    }

    function logout() {
        localStorage.removeItem('ultima_user');
        location.reload();
    }

    // --- 2. Profile & Search ---
    function openProfileModal() { document.getElementById('profile-modal').style.display = 'flex'; }
    
    function saveProfile() {
        const newBio = document.getElementById('edit-bio').value;
        const newAva = document.getElementById('edit-avatar').value;
        socket.emit('update-profile', { username: me.username, bio: newBio, avatar: newAva });
        document.getElementById('profile-modal').style.display = 'none';
    }

    socket.on('profile-updated', (user) => {
        me = user;
        localStorage.setItem('ultima_user', JSON.stringify(user));
        updateMyUI(user);
        alert('Profile Updated!');
    });

    function searchUser(query) {
        if(query.length < 2) { document.getElementById('search-results').style.display = 'none'; return; }
        socket.emit('search-user', query);
    }

    socket.on('search-result', (data) => {
        const resDiv = document.getElementById('search-results');
        resDiv.style.display = 'block';
        resDiv.innerHTML = '';
        
        if(data.found) {
            const div = document.createElement('div');
            div.className = 'result-item';
            div.innerHTML = `<img src="${data.avatar}" class="avatar-sm"> 
                             <div><b>${data.username}</b><br><small style="color:#94a3b8">${data.bio}</small></div>`;
            div.onclick = () => {
                if(data.username === me.username) return;
                requestChat(data.username);
            };
            resDiv.appendChild(div);
        } else {
            resDiv.innerHTML = '<div style="padding:10px; color:#94a3b8">User not found</div>';
        }
    });

    function requestChat(targetUser) {
        if(confirm(`Send message request to ${targetUser}?`)) {
            socket.emit('send-request', { sender: me.username, target: targetUser });
        }
    }

    socket.on('req-feedback', msg => alert(msg));
              </script>
    <script>
    // --- 3. Friends & Requests ---
    function loadFriendsList(friends, requests) {
        const list = document.getElementById('friends-list');
        list.innerHTML = '';
        
        // Show Requests First
        requests.forEach(req => {
            const div = document.createElement('div');
            div.className = 'result-item';
            div.style.background = '#334155';
            div.innerHTML = `<div style="flex:1"><b>${req}</b> wants to chat</div> 
                             <button onclick="acceptReq('${req}')" style="background:#2dd4bf; border:none; padding:5px 10px; border-radius:5px;">Accept</button>`;
            list.appendChild(div);
        });

        // Show Friends
        friends.forEach(f => {
            const div = document.createElement('div');
            div.className = 'result-item';
            div.innerHTML = `<img src="https://cdn-icons-png.flaticon.com/512/149/149071.png" class="avatar-sm"> 
                             <div style="flex:1"><b>${f}</b><br><small style="color:#94a3b8">Tap to chat</small></div>
                             <i class="fas fa-camera" style="color:#64748b"></i>`;
            div.onclick = () => startChat(f);
            list.appendChild(div);
        });
    }

    function acceptReq(friend) { socket.emit('accept-request', { myName: me.username, friendName: friend }); }
    
    socket.on('new-request', () => location.reload()); // Simple reload to sync
    socket.on('friend-added', () => location.reload());

    // --- 4. Chat System (Rocket Mode) ---
    function startChat(friendName) {
        document.getElementById('main-view').style.display = 'none';
        document.getElementById('chat-view').style.display = 'flex';
        document.getElementById('chat-name').innerText = friendName;
        document.getElementById('chat-box').innerHTML = '';
        
        currentRoom = [me.username, friendName].sort().join('-');
        socket.emit('join-chat', { roomID: currentRoom });
    }

    function closeChat() {
        document.getElementById('chat-view').style.display = 'none';
        document.getElementById('main-view').style.display = 'block';
        currentRoom = null;
    }

    function handleTyping() {
        socket.emit('typing', { roomID: currentRoom, sender: me.username });
        clearTimeout(typingTimer);
        typingTimer = setTimeout(() => socket.emit('stop-typing', { roomID: currentRoom }), 1000);
    }

    socket.on('display-typing', () => document.getElementById('typing-ind').style.visibility = 'visible');
    socket.on('hide-typing', () => document.getElementById('typing-ind').style.visibility = 'hidden');

    function sendMsg(fileData = null) {
        const text = document.getElementById('msg-input').value;
        if(!text && !fileData) return;
        
        socket.emit('private-message', {
            roomID: currentRoom,
            sender: me.username,
            text: text,
            file: fileData // Only Photos
        });
        document.getElementById('msg-input').value = '';
    }

    function uploadPhoto(input) {
        const file = input.files[0];
        if(!file) return;
        if(file.size > 2 * 1024 * 1024) return alert('Photo too big! Keep under 2MB for Rocket Speed.');
        
        const reader = new FileReader();
        reader.onload = () => sendMsg(reader.result);
        reader.readAsDataURL(file);
    }

    socket.on('receive-message', (msg) => {
        const div = document.createElement('div');
        div.className = `msg ${msg.sender === me.username ? 'msg-me' : 'msg-friend'}`;
        
        let content = '';
        if(msg.file) content += `<img src="${msg.file}"><br>`;
        if(msg.text) content += `<span>${msg.text}</span>`;
        
        div.innerHTML = content + `<br><small style="font-size:9px; opacity:0.6">${new Date(msg.createdAt).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</small>`;
        
        document.getElementById('chat-box').appendChild(div);
        document.getElementById('chat-box').scrollTop = document.getElementById('chat-box').scrollHeight;

        // Notification Sound
        if(msg.sender !== me.username) {
            document.getElementById('notif-sound').play().catch(e => console.log('Interact first'));
        }
    });

    socket.on('load-messages', (msgs) => {
        msgs.forEach(msg => {
            // Re-use logic (simplified for brevity)
            const div = document.createElement('div');
            div.className = `msg ${msg.sender === me.username ? 'msg-me' : 'msg-friend'}`;
            let content = '';
            if(msg.file) content += `<img src="${msg.file}"><br>`;
            if(msg.text) content += `<span>${msg.text}</span>`;
            div.innerHTML = content;
            document.getElementById('chat-box').appendChild(div);
        });
        document.getElementById('chat-box').scrollTop = document.getElementById('chat-box').scrollHeight;
    });
</script>
</body>
</html>

