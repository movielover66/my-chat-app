<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ultima Chat - By Pritam</title>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --primary: #7c3aed; --bg: #0f172a; --card: #1e293b; --text: #f1f5f9; --input: #334155; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        .hidden { display: none !important; }
        
        /* Auth */
        #auth-view { height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: radial-gradient(circle, #1e1b4b, #0f172a); padding: 20px; }
        .auth-card { background: rgba(30, 41, 59, 0.8); backdrop-filter: blur(10px); padding: 30px; border-radius: 20px; width: 100%; max-width: 350px; text-align: center; border: 1px solid rgba(255,255,255,0.1); }
        
        /* UI Elements */
        input { width: 100%; padding: 14px; background: var(--input); border: none; border-radius: 10px; color: white; margin-bottom: 15px; outline: none; }
        .btn-primary { width: 100%; padding: 14px; background: linear-gradient(135deg, #7c3aed, #4f46e5); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; }
        
        /* Online/Offline Status */
        .online-dot { width: 10px; height: 10px; background: #22c55e; border-radius: 50%; display: inline-block; box-shadow: 0 0 8px #22c55e; margin-right: 5px; }
        .offline-text { color: #94a3b8; font-size: 11px; }

        /* Messages & Ticks */
        .msg { max-width: 75%; padding: 10px; border-radius: 15px; margin-bottom: 8px; position: relative; }
        .msg-me { align-self: flex-end; background: #7c3aed; }
        .msg-friend { align-self: flex-start; background: #334155; }
        .tick { font-size: 10px; margin-left: 5px; color: #94a3b8; }
        .tick.seen { color: #38bdf8; }

        /* Voice Player */
        .voice-player { display: flex; align-items: center; gap: 8px; padding: 5px; background: rgba(0,0,0,0.2); border-radius: 10px; cursor: pointer; }
        .mic-active { color: #ef4444 !important; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0; } }

        .footer-credit { position: fixed; bottom: 10px; width: 100%; text-align: center; color: #475569; font-size: 12px; font-weight: bold; }
        @media(min-width: 768px) { body { max-width: 450px; margin: 0 auto; border: 1px solid #334155; } }
    </style>
</head>
<body>
    <audio id="notif-sound" src="https://assets.mixkit.co/active_storage/sfx/2346/2346-preview.m4a"></audio>

    <div id="auth-view">
        <div class="auth-card">
            <h1 style="color:#a78bfa; margin-bottom:10px;">⚡ Ultima</h1>
            <input type="text" id="username" placeholder="Username">
            <input type="password" id="password" placeholder="Password">
            <button class="btn-primary" onclick="handleAuth()">Login / Register</button>
            <p id="auth-err" style="color:#ef4444; font-size:12px; margin-top:10px;"></p>
        </div>
        <div class="footer-credit">Developed by PRITAM</div>
    </div>

    <div id="main-view" class="hidden" style="flex:1; display:flex; flex-direction:column;">
        <div style="padding:15px; background:var(--card); display:flex; justify-content:space-between; align-items:center;">
            <div style="display:flex; align-items:center; gap:10px;" onclick="openProfileModal()">
                <img id="my-dp" src="" style="width:40px; height:40px; border-radius:50%; object-fit:cover;">
                <div><b id="my-name">...</b><br><small style="color:#2dd4bf;">● Online</small></div>
            </div>
            <button onclick="logout()" style="background:none; border:none; color:#ef4444;"><i class="fas fa-power-off"></i></button>
        </div>
        
        <div style="padding:10px;"><input type="text" placeholder="Search friends..." oninput="searchUser(this.value)"></div>
        <div id="friends-list" style="flex:1; overflow-y:auto; padding:10px;"></div>
        <div class="footer-credit">Developed by PRITAM</div>
    </div>

    <div id="chat-view" class="hidden" style="position:fixed; inset:0; background:var(--bg); z-index:100; flex-direction:column;">
        <div style="padding:10px; background:var(--card); display:flex; align-items:center; gap:10px;">
            <i class="fas fa-arrow-left" onclick="closeChat()"></i>
            <div style="flex:1;">
                <b id="chat-name">User</b><br>
                <span id="chat-status" class="offline-text">Offline</span>
            </div>
        </div>
        <div id="chat-box" style="flex:1; padding:15px; overflow-y:auto; display:flex; flex-direction:column;"></div>
        <div id="typing-ind" style="font-size:12px; color:#2dd4bf; padding-left:15px; visibility:hidden;">Typing...</div>
        <div style="padding:10px; background:var(--card); display:flex; align-items:center; gap:10px;">
            <i class="fas fa-microphone" id="voice-btn" style="font-size:20px; color:#94a3b8;" onclick="toggleVoice()"></i>
            <input type="text" id="msg-input" placeholder="Message..." style="margin:0;" oninput="handleTyping()">
            <i class="fas fa-paper-plane" style="color:var(--primary); font-size:22px;" onclick="sendMsg()"></i>
        </div>
    </div>

    <div id="profile-modal" class="hidden" style="position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:200; align-items:center; justify-content:center; display:flex;">
        <div class="auth-card">
            <h3>Edit Profile</h3>
            <img id="edit-preview" style="width:80px; height:80px; border-radius:50%; margin:15px auto; display:block;">
            <input type="file" id="up-file" hidden onchange="previewMyDP(this)">
            <button class="btn-primary" onclick="document.getElementById('up-file').click()">Select Photo</button>
            <button class="btn-primary" style="margin-top:10px;" onclick="saveProfile()">Save</button>
            <button onclick="document.getElementById('profile-modal').classList.add('hidden')" style="background:none; border:none; color:grey; margin-top:10px;">Close</button>
        </div>
    </div>
<script>
    const socket = io();
    let me = JSON.parse(localStorage.getItem('ultima_user')) || null;
    let currentRoom = null;
    let onlineList = [];
    let mediaRecorder, audioChunks = [];

    window.onload = () => { if(me) { initApp(me); socket.emit('login', me); } };

    function handleAuth() {
        const u = document.getElementById('username').value.trim();
        const p = document.getElementById('password').value.trim();
        if(!u || !p) return;
        socket.emit('register', { username: u, password: p });
        socket.once('auth-error', (err) => {
            if(err === 'Username taken!') socket.emit('login', { username: u, password: p });
            else document.getElementById('auth-err').innerText = err;
        });
    }

    socket.on('auth-success', (user) => { 
        me = user; localStorage.setItem('ultima_user', JSON.stringify(user)); initApp(user); 
    });

    function initApp(user) {
        document.getElementById('auth-view').classList.add('hidden');
        document.getElementById('main-view').classList.remove('hidden');
        document.getElementById('my-name').innerText = user.username;
        document.getElementById('my-dp').src = user.avatar || "https://cdn-icons-png.flaticon.com/512/149/149071.png";
        socket.emit('join-user', user.username);
        renderFriends(user.friends || []);
    }

    // --- Online Status Logic ---
    socket.on('user-online-status', (list) => {
        onlineList = list;
        const status = document.getElementById('chat-status');
        const activeChat = document.getElementById('chat-name').innerText;
        if(onlineList.includes(activeChat)) {
            status.innerHTML = `<span class="online-dot"></span> Online`;
            document.getElementById('voice-btn').style.opacity = "1";
        } else {
            status.innerHTML = "Offline";
            document.getElementById('voice-btn').style.opacity = "0.3";
        }
    });

    // --- Voice Recording (Only if Online) ---
    async function toggleVoice() {
        if(!onlineList.includes(document.getElementById('chat-name').innerText)) {
            return alert("Friend is offline! Voice messages only allowed when online.");
        }
        if(!mediaRecorder || mediaRecorder.state === "inactive") {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.start();
            document.getElementById('voice-btn').classList.add('mic-active');
            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
            mediaRecorder.onstop = () => {
                const blob = new Blob(audioChunks, { type: 'audio/mp3' });
                const reader = new FileReader();
                reader.onloadend = () => socket.emit('private-message', { roomID: currentRoom, sender: me.username, voice: reader.result });
                reader.readAsDataURL(blob);
                audioChunks = [];
            };
        } else {
            mediaRecorder.stop();
            document.getElementById('voice-btn').classList.remove('mic-active');
        }
    }

    // --- Message Logic with Ticks ---
    function sendMsg() {
        const text = document.getElementById('msg-input').value;
        if(!text) return;
        socket.emit('private-message', { roomID: currentRoom, sender: me.username, text });
        document.getElementById('msg-input').value = '';
    }

    socket.on('receive-message', (msg) => {
        const div = document.createElement('div');
        div.className = `msg ${msg.sender === me.username ? 'msg-me' : 'msg-friend'}`;
        
        let content = msg.text || '';
        if(msg.voice) content = `<div class="voice-player" onclick="new Audio('${msg.voice}').play()"><i class="fas fa-play"></i> Voice Message</div>`;
        
        const tick = msg.sender === me.username ? `<i class="fas fa-check tick ${msg.seen?'seen':''}"></i>` : '';
        div.innerHTML = `${content} <br> <small style="font-size:9px; opacity:0.7">${new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})} ${tick}</small>`;
        
        document.getElementById('chat-box').appendChild(div);
        document.getElementById('chat-box').scrollTop = document.getElementById('chat-box').scrollHeight;
        if(msg.sender !== me.username) document.getElementById('notif-sound').play();
    });

    function startChat(name) {
        document.getElementById('chat-view').style.display = 'flex';
        document.getElementById('chat-name').innerText = name;
        document.getElementById('chat-box').innerHTML = '';
        currentRoom = [me.username, name].sort().join('-');
        socket.emit('join-chat', { roomID: currentRoom });
    }

    function closeChat() { document.getElementById('chat-view').style.display = 'none'; }
    function logout() { localStorage.clear(); location.reload(); }
    
    // UI Helpers
    function renderFriends(friends) {
        const list = document.getElementById('friends-list');
        list.innerHTML = friends.length ? '' : 'No friends yet.';
        friends.forEach(f => {
            const div = document.createElement('div');
            div.style = "padding:10px; background:var(--card); margin-bottom:5px; border-radius:10px;";
            div.innerHTML = `<b>${f}</b>`;
            div.onclick = () => startChat(f);
            list.appendChild(div);
        });
    }
</script>
</body>
</html>



