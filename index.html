<!DOCTYPE html>
<html>
<head>
    <title>Secure Private Chat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { margin: 0; font-family: sans-serif; background: #121212; color: white; overflow: hidden; }
        
        /* স্ক্রিন কন্ট্রোল */
        .screen { display: none; height: 100vh; flex-direction: column; }
        .active { display: flex; }

        /* ১. লগইন স্ক্রিন */
        #login-screen { justify-content: center; align-items: center; padding: 20px; }
        input, button { padding: 10px; margin: 10px 0; width: 100%; max-width: 300px; border-radius: 5px; border: none; }
        input { background: #333; color: white; }
        button { background: #007bff; color: white; cursor: pointer; font-weight: bold; }
        .toggle-btn { background: none; color: #007bff; text-decoration: underline; cursor: pointer; margin-top: 10px; }

        /* ২. ড্যাশবোর্ড (লিস্ট) */
        #dashboard-screen { padding: 10px; }
        .header { display: flex; align-items: center; justify-content: space-between; padding: 10px; background: #1e1e1e; }
        .my-dp { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid #007bff; }
        
        .section-title { margin-top: 20px; color: #888; font-size: 14px; text-transform: uppercase; }
        .user-list { list-style: none; padding: 0; }
        .user-list li { padding: 15px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .user-list li:hover { background: #1e1e1e; }
        
        /* ৩. চ্যাট স্ক্রিন */
        #chat-header { padding: 15px; background: #1e1e1e; display: flex; align-items: center; }
        #back-btn { margin-right: 15px; background: none; color: white; font-size: 20px; width: auto; padding: 0; }
        #chat-messages { flex-grow: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        
        .message { padding: 8px 15px; border-radius: 20px; max-width: 75%; word-wrap: break-word; font-size: 14px; }
        .my-msg { background: #007bff; align-self: flex-end; }
        .other-msg { background: #333; align-self: flex-start; }

        #chat-form { display: flex; padding: 10px; background: #1e1e1e; }
        #msg-input { flex-grow: 1; margin: 0 10px 0 0; }
        #send-btn { width: auto; margin: 0; }

        /* ইউটিলিটি */
        .hidden { display: none; }
        #file-input { display: none; }
        label[for="file-input"] { display: block; background: #333; padding: 10px; text-align: center; border-radius: 5px; cursor: pointer; max-width: 300px; margin: 10px auto; }
    </style>
</head>
<body>

    <div id="login-screen" class="screen active">
        <h2 id="auth-title">Login</h2>
        <div id="preview-container" class="hidden">
            <img id="preview-dp" src="" class="my-dp" style="width: 80px; height: 80px; margin: 0 auto; display: block;">
        </div>
        <label for="file-input" id="upload-label" class="hidden">Upload DP (Click Here)</label>
        <input type="file" id="file-input" accept="image/*">
        
        <input type="text" id="username" placeholder="Username">
        <input type="password" id="password" placeholder="Password">
        <button id="auth-btn" onclick="handleAuth()">Login</button>
        <p class="toggle-btn" onclick="toggleAuthMode()">Create New Account</p>
    </div>

    <div id="dashboard-screen" class="screen">
        <div class="header">
            <h3>My Chats</h3>
            <img id="my-nav-dp" src="" class="my-dp">
        </div>

        <div style="display: flex; gap: 5px;">
            <input type="text" id="search-user" placeholder="Search username...">
            <button onclick="sendRequest()" style="width: 80px;">Add</button>
        </div>

        <div id="request-section" class="hidden">
            <div class="section-title">Requests</div>
            <ul id="request-list" class="user-list"></ul>
        </div>

        <div class="section-title">Friends</div>
        <ul id="friend-list" class="user-list"></ul>
    </div>

    <div id="chat-screen" class="screen">
        <div id="chat-header">
            <button id="back-btn" onclick="goBack()">←</button>
            <h3 id="chat-partner-name">User</h3>
        </div>
        <div id="chat-messages"></div>
        <form id="chat-form">
            <input id="msg-input" autocomplete="off" placeholder="Type a message..." />
            <button id="send-btn">Send</button>
        </form>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let isLoginMode = true;
        let myUsername = '';
        let currentChatFriend = '';
        let uploadedAvatar = 'https://cdn-icons-png.flaticon.com/512/149/149071.png'; // ডিফল্ট ছবি

        // --- স্ক্রিন হ্যান্ডেলিং ---
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        // --- ইমেজ আপলোড লজিক (Base64) ---
        document.getElementById('file-input').addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    uploadedAvatar = e.target.result;
                    document.getElementById('preview-dp').src = uploadedAvatar;
                }
                reader.readAsDataURL(file);
            }
        });

        // --- অথেনটিকেশন (Login/Signup) ---
        function toggleAuthMode() {
            isLoginMode = !isLoginMode;
            document.getElementById('auth-title').innerText = isLoginMode ? 'Login' : 'Create Account';
            document.getElementById('auth-btn').innerText = isLoginMode ? 'Login' : 'Sign Up';
            document.querySelector('.toggle-btn').innerText = isLoginMode ? 'Create New Account' : 'Back to Login';
            
            // সাইন আপ হলে ছবি আপলোড দেখাবো
            if (!isLoginMode) {
                document.getElementById('upload-label').classList.remove('hidden');
                document.getElementById('preview-container').classList.remove('hidden');
                document.getElementById('preview-dp').src = uploadedAvatar;
            } else {
                document.getElementById('upload-label').classList.add('hidden');
                document.getElementById('preview-container').classList.add('hidden');
            }
        }

        function handleAuth() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            if (!username || !password) return alert("সব তথ্য পূরণ করুন!");

            if (isLoginMode) {
                socket.emit('login', { username, password });
            } else {
                socket.emit('register', { username, password, avatar: uploadedAvatar });
            }
        }

        socket.on('auth-success', (data) => {
            myUsername = data.username;
            document.getElementById('my-nav-dp').src = data.avatar || uploadedAvatar;
            showScreen('dashboard-screen');
            
            // পুরনো বন্ধুদের লোড করা
            updateFriendList(data.friends);
            updateRequestList(data.requests);
        });

        socket.on('auth-error', (msg) => alert(msg));

        // --- ফ্রেন্ড সিস্টেম ---
        function sendRequest() {
            const target = document.getElementById('search-user').value.trim();
            if (target) {
                socket.emit('send-request', target);
                document.getElementById('search-user').value = '';
            }
        }

        socket.on('request-error', (msg) => alert(msg));
        socket.on('request-sent', (msg) => alert(msg));
        
        socket.on('new-request', (fromUser) => {
            alert(fromUser + " আপনাকে রিকোয়েস্ট পাঠিয়েছে!");
            const list = document.getElementById('request-list');
            addRequestItem(list, fromUser);
            document.getElementById('request-section').classList.remove('hidden');
        });

        function addRequestItem(list, name) {
            const li = document.createElement('li');
            li.innerHTML = `${name} <button style="width:auto; padding:5px 10px; font-size:12px;" onclick="accept('${name}')">Accept</button>`;
            list.appendChild(li);
        }

        function accept(name) {
            socket.emit('accept-request', name);
            // লিস্ট থেকে সরিয়ে ফেলা
            const list = document.getElementById('request-list');
            // সিম্পল রিলোড বা রিমুভ লজিক (সহজের জন্য আমরা পরে লিস্ট আপডেট করি)
            list.innerHTML = ''; 
        }

        socket.on('friend-added', (name) => {
            const list = document.getElementById('friend-list');
            const li = document.createElement('li');
            li.textContent = name;
            li.onclick = () => startChat(name);
            list.appendChild(li);
        });

        function updateFriendList(friends) {
            const list = document.getElementById('friend-list');
            list.innerHTML = '';
            friends.forEach(name => {
                const li = document.createElement('li');
                li.textContent = name;
                li.onclick = () => startChat(name);
                list.appendChild(li);
            });
        }

        function updateRequestList(requests) {
            const list = document.getElementById('request-list');
            list.innerHTML = '';
            if(requests && requests.length > 0) {
                document.getElementById('request-section').classList.remove('hidden');
                requests.forEach(name => addRequestItem(list, name));
            }
        }

        // --- চ্যাট সিস্টেম ---
        function startChat(friendName) {
            currentChatFriend = friendName;
            document.getElementById('chat-partner-name').innerText = friendName;
            document.getElementById('chat-messages').innerHTML = ''; // ক্লিয়ার
            socket.emit('join-chat', friendName);
            showScreen('chat-screen');
        }

        function goBack() {
            showScreen('dashboard-screen');
            currentChatFriend = '';
        }

        document.getElementById('chat-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const input = document.getElementById('msg-input');
            if (input.value && currentChatFriend) {
                socket.emit('private-message', { friendName: currentChatFriend, msg: input.value });
                input.value = '';
            }
        });

        socket.on('receive-message', (data) => {
            // যদি আমি চ্যাট স্ক্রিনে থাকি এবং এই মানুষের সাথেই কথা বলছি
            if (currentChatFriend && (data.sender === currentChatFriend || data.sender === myUsername)) {
                const div = document.createElement('div');
                div.classList.add('message');
                div.classList.add(data.sender === myUsername ? 'my-msg' : 'other-msg');
                div.textContent = data.text;
                document.getElementById('chat-messages').appendChild(div);
                document.getElementById('chat-messages').scrollTo(0, 99999);
            }
        });

        socket.on('load-messages', (msgs) => {
            const container = document.getElementById('chat-messages');
            container.innerHTML = '';
            msgs.forEach(data => {
                const div = document.createElement('div');
                div.classList.add('message');
                div.classList.add(data.sender === myUsername ? 'my-msg' : 'other-msg');
                div.textContent = data.text;
                container.appendChild(div);
            });
            container.scrollTo(0, 99999);
        });

    </script>
</body>
</html>
